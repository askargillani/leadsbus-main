<div class="header">
    <span class="header-title">LeadsBus -</span>
    <span class="header-subtitle">&nbsp;HELPING THOUSANDS OF BUSINESSES SCALE BUSINESSES</span> 
</div>

<div class="chat-wrapper">
    <div class="sidebar">
        <img src="../../../assets/images/back-button.svg" class="back-button" (click)="onBackButtonClick()">
        <img src="../../../assets/images/logout.svg" class="logout-button" (click)="onLogout()">
    </div>
    <div class="chat-container">
        <div *ngIf="isLoading" class="loader-overlay">
            <div class="loader"></div>
            <div class="loader-text" *ngIf="chatSelected == false">
                Loading recipients... {{containerService.allConversations?.data?.length || 0}} loaded
            </div>
        </div>
        <div class="user-list-container">
            <div class="productivity-img-container">
                <img [src]="containerService.pageImageUrl" class="productivity-img">
            </div>
            <div class="page-name">
                <h1><b>{{containerService.pageName}}</b></h1>
                <p 
                  class="messages-left-text" 
                  [ngClass]="{'low-messages': containerService.messagesLeft < 100, 'no-messages': containerService.messagesLeft === 0}">
                  Available Messages: {{containerService.messagesLeft || 0}}
                  <span *ngIf="containerService.messagesLeft === 0" class="warning-text">⚠️ No messages left!</span>
                </p>
            </div>
            <div class="search-container">
                <input class="search-input" placeholder="Search conversations..." [(ngModel)]="searchQuery" (ngModelChange)="filterRecipients()">
            </div>
            <div class="user-list">
                <div *ngFor="let user of conversations; let i = index" class="user">
                    <div class="user-info" (click)="selectChat(user.id, user.participants.data[0].name, user.participants.data[0].id)">
                        <div class="user-name">Customer</div>
                        <div class="latest-message">{{user.snippet}}</div>
                    </div>
                </div>
            </div>
            <div class="load-more-container load-more-container-styled" *ngIf="containerService.pageConversations?.paging?.next">
                <button class="load-more-button load-more-button-styled" (click)="LoadMore()">Load More</button>
            </div>
        </div>
        <div style="width: 100%" *ngIf="chatSelected">
            <div class="message-sender">
                <div class="message-sender-container">
                    <h2>Customer</h2> 
                </div>
            </div>
            <div class="message-panel">
                <div *ngFor="let text of chatMessages" class="message-text">
                  <div [ngClass]="{'sender-message': text.from.name == containerService.pageName, 'receiver-message': text.from.name != containerService.pageName}" class="message-text-container">
                    <div>
                      <p class="m-0"><strong>{{text.from.name == containerService.pageName ? 'You' : 'Customer'}}</strong></p>
                      <span *ngIf="text.message">{{ text.message }}</span>
                      <ng-container *ngIf="text.attachments && text.attachments.data && text.attachments.data.length">
                        <ng-container *ngFor="let att of text.attachments.data">
                          <img 
                            *ngIf="att.mime_type && att.mime_type.startsWith('image/')" 
                            [src]="att.image_data?.url || att.file_url" 
                            alt="Image" 
                            style="max-width: 200px; max-height: 200px; display: block; margin-top: 5px;">
                        </ng-container>
                      </ng-container>
                    </div>
                  </div>
                </div>
                <div class="input-div">
                  <!-- Attach button and hidden file input -->
                  <label class="attach-label" title="Attach image">
                    <img src="../../../assets/images/attach.svg" class="attach-icon" alt="Attach" />
                    <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)" style="display: none;" />
                  </label>
                  <input 
                    class="input-field" 
                    [(ngModel)]="messageInput" 
                    [disabled]="isLoading || !chatSelected" 
                    placeholder="Type a message..." 
                    (keydown.enter)="onSend()">
                  <img src="../../../assets/images/send.svg" class="send-icon" (click)="onSend()" [class.disabled]="isLoading || !chatSelected">

                  <!-- Show selected image preview with cross -->
                  <div *ngIf="selectedFile" class="attachment-preview">
                    <img [src]="selectedFilePreview" alt="Preview" class="preview-img" />
                    <span class="remove-attachment" (click)="removeAttachment()">&#10005;</span>
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New small dialog for content type selection -->
<div class="content-type-dialog" *ngIf="showContentTypeDialog">
  <div class="dialog-content">
    <div class="dialog-header">
      <span>Select Content Type</span>
    </div>
    <div class="dialog-body">
      <label>
        <input type="radio" name="contentTypeDialog" value="CONFIRMED_EVENT_UPDATE" [(ngModel)]="selectedContentType">
        Confirmed Update
      </label>
      <label>
        <input type="radio" name="contentTypeDialog" value="POST_PURCHASE_UPDATE" [(ngModel)]="selectedContentType">
        Post Purchase Update
      </label>
      <label>
        <input type="radio" name="contentTypeDialog" value="ACCOUNT_UPDATE" [(ngModel)]="selectedContentType">
        Account Update
      </label>
    </div>
    <div class="dialog-footer">
      <button class="tick-button" (click)="sendMessageWithContentType()">✔</button>
    </div>
  </div>
</div>
